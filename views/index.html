<html>
  <head>
    <title>POIs</title>
		<!-- leaflet -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
  </head>
  <body style="margin:0">
		<div id="map" style="width: 100vw; height: 100vh;" />

		<script>
			window.onload = function() {
				var map = L.map('map').setView([37.9849, 23.7459], 13);
			
				navigator.geolocation.getCurrentPosition((position) => {
          const x = position.coords.longitude;
          const y = position.coords.latitude;
          const r = 1000;

          fetch(`/geosearch?lat=${y}&lon=${x}&radius=${r}`)
            .then(res => res.json())
            .then(res => res.results)
            .then((pois) => {
              pois.forEach((poi) => {
              if (!poi || !poi.coordinates) return;
              L.marker([poi.coordinates.lat, poi.coordinates.lon])
                .addTo(map)
                .bindPopup(`
                    <div>
                      <a href="${poi.url}">
                        <img style="height: 100px" src="${poi.images && poi.images[0]}"/>
                        <h4>${poi.title}</h4>
                      </a>
                      <p>${poi.summary.slice(0, 300)}</p>
                    </div>
                    `);
              });
            })
            .catch((error) => { 
              console.error('caught error', error);
            });
				}, 
		     (error) => {
          console.error('geolocation error');  
         },
         {
           enableHighAccuracy: false,
           timeout: 5000,
         });

				L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
				id: 'mapbox.streets'
			}).addTo(map);
		}
		</script>
  </body>
</html>
